# Clang static analyzer и CVE-2014-8130
[Clang static analyzer](https://clang-analyzer.llvm.org/) - это статический анализатор на базе компилятора clang, который, в свою очередь, входит в проект LLVM.
Уязвимость CVE-2014-8130 была обнаружена в библиотеке для работы с TIFF-файлами [libtiff](https://gitlab.com/libtiff/libtiff).
Давайте попробуем обнаружить и исправить эту уязвимость, опираясь на статический анализ с помощью clang static analyzer.

В ходе выполнения заданий 2 части у нас должны получиться следующие результаты:
- скриншоты выполнения пунктов задания
- pull request в репозиторий с заданием

## Настройка окружения
Поскольку clang static analyzer построен на базе компилятора clang, он позволяет проводить более глубокий анализ программы путем участия в ее сборке. Следовательно, для такого анализа нам потребуется собрать библиотеку libtiff, а значит нам потребуется установить ее зависимости:
```shell
apt-get install make libSM-devel libXi-devel libXmu-devel libfreeglut-devel libjpeg-devel liblzma-devel libwebp-devel libzstd-devel zlib-devel libdeflate-devel
```
Также установим LLVM и сам clang static analyzer

```shell
apt-get install clang18.1-analyzer gcc-c++ llvm18.1
```
Склонируем себе репозиторий с заданием и проверяемым проектом

```shell
git clone https://github.com/nikitaSSU/rbpo-task
```

## Статический анализ
Чтобы провести статический анализ с использованием clang static analyzer, можно использовать утилиту scan-build, которая проведет сборку нашего проекта с необходимыми для статического анализа настройками компилятора. Поскольку наш проект собирается с помощью скрипта `configure` и утилиты `make`, то для сборки со статическим анализом используем следующие команды в папке с проектом

```shell
scan-build ./configure
scan-build make -j4
```
Здесь ключ `-j4` запускает сборку в несколько потоков, что позволяет ускорить этот процесс.

## Разбор срабатываний
После завершения работы утилиты scan-build будет выведено сообщение вида

```shell
scan-build: Run 'scan-view /tmp/.private/[..]' to examine bug reports.
```
Запустив указанную команду мы сможем ознакомиться с результатами статического анализа в любом браузере по указанному в выводе команды адресу.

Нас будет интересовать первое срабатывание детектора `Division by zero` в файле `libtiff/tif_write.c:119`.
Как видим, `td->td_stripsperimage` может быть равным нулю, в результате чего может возникнуть деление на ноль.

## Исправление ошибки
Для исправления ошибки можно добавить проверку, равен ли `td->td_stripsperimage` нулю непосредственно перед проведением деления. 

Самостоятельно проведите указанное или подобное ему исправление и повторно запустите статический анализ (для этого потребуется сначала удалить результаты предыдущей сборки с помощью `make clean`). Убедитесь, что рассматриваемое срабатывание больше не появляется.

## Создание pull-request'a
Внесите свое исправление в систему контроля версий (только исправление в `libtiff/tif_write.c:119`) и создайте pull-request в [репозиторий задания](https://github.com/nikitaSSU/rbpo-task).

Дополнительно:
- Сравните ваше исправление с коммитом, который действительно использовался для исправления этой уязвимости (информацию об уязвимости удобно смотреть по ее идентификатору на https://CVE.org).


* Выражаем благодарность [Базальт СПО](https://www.basealt.ru) за возможность использования задания.